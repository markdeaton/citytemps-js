<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>US City Heat Index</title>

    <link rel="stylesheet" href="https://js.arcgis.com/3.9/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.9/js/esri/css/esri.css">
 	<link rel="stylesheet" href="js/customInfoWindow/CustomInfoWindow.css"/>
    <link rel="stylesheet" href="css/layout.css">
	<!-- <link rel="stylesheet" href="dojox/grid/resources/Grid.css">
	<link rel="stylesheet" href="dojox/grid/resources/claroGrid.css"> -->
		
    <script>
    var dojoConfig = {
   	// parseOnLoad: true,
  		packages: [{
        	name: 		"customInfoWindow",
        	location: 	location.pathname.replace(/\/[^/]+$/, '') + "/js/customInfoWindow"
		},{
			name:		"graphicsAnimation",
			location:	location.pathname.replace(/\/[^/]+$/, '') + "/js/geometry-animation"
		}]
    };
    </script>

    <script src="https://js.arcgis.com/3.9/"></script>
 	<!-- <script src="js/AnimatePolyline.js"></script> -->
 	<script src="config.js"></script>
 		
    <script type="text/javascript">
	require([
        "dojo/parser",
        "dojo/ready",
        "dojo/on",
        "dojo/_base/lang",
        "dijit/registry",
        "dijit/layout/BorderContainer",
        "dijit/layout/ContentPane",
        "dijit/form/Select",
        "dijit/form/CheckBox",
        "dojo/dom",
        "dojo/dom-construct",
        "dojo/dom-style",
        "dojo/data/ItemFileReadStore",
        "dojox/grid/DataGrid",
        "dojox/json/query",
		"dojox/charting/Chart",
 		"dojox/charting/themes/Claro",
	    "dojox/charting/plot2d/Lines",
	    "dojox/charting/plot2d/Markers",
	    "dojox/charting/action2d/Tooltip",
	    "dojox/charting/axis2d/Default",
        "esri/map", 
        "esri/urlUtils",
        "esri/arcgis/utils",
        "esri/geometry/Extent",
        "esri/layers/ArcGISDynamicMapServiceLayer",
        "esri/layers/ArcGISTiledMapServiceLayer",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/geometry/Polyline",
        "esri/symbols/SimpleLineSymbol",
        "esri/renderers/SimpleRenderer",
        "esri/Color",
        "esri/graphic",
        "customInfoWindow/CustomInfoWindow",
        "graphicsAnimation/PolylineAnimation",
        "esri/InfoTemplate",
        "esri/dijit/Legend",
        "esri/dijit/Scalebar",        
        "dojo/domReady!"
	], function(
        parser,
        ready,
        on,
        lang,
        registry,
        BorderContainer,
        ContentPane,
        Select,
        CheckBox,
        dom,
        domConstruct,
        domStyle,
        ItemFileReadStore,
        DataGrid,
        JSONQuery,
        Chart,
        ChartTheme,
        ChartLines,
        ChartMarkers,
        ChartTooltip,
        ChartDefaultAxes,
        Map,
        urlUtils,
        arcgisUtils,
        Extent,
        ArcGISDynamicMapServiceLayer,
        ArcGISTiledMapServiceLayer,
        FeatureLayer,
        GraphicsLayer,
        Polyline,
        SimpleLineSymbol,
        SimpleRenderer,
        Color,
        Graphic,
        CustomInfoWindow,
        PolylineAnimation,
        InfoTemplate,
        Legend,
        Scalebar
		) {
	    var glCityConnectors; 	// Graphics layer for the lines connecting a chosen city to its closest analogs
	    var flCities;			// Graphics layer for the city features
	    var gpcSelectedCity = null;
	    var itPopup;
	    var aryChartData, cityChart;
	    const chartSeries1 = "Var1Series";
	    const chartSeries2= "Var2Series";
		const baselineYear = 2010;

	    var map;
	    
		var ddlFirstComparisonVariable;
		var ddlYear;
		var ddlSecondComparisonVariable;
		var cbShowSecondComparisonVariable;
		var dgPrimary, dgSecondary;
	    const cityConnectorColor1 = "#339966";
	    const cityConnectorColor2 = "#993366";
		const slsCityConnector1 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color(cityConnectorColor1), 2);
		const slsCityConnector2 = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color(cityConnectorColor2), 2);
		// Reasons for recalculation; note that these could be used additively, in combination. Right now, they're not.
		const REASON_CHANGED_PRIMARY_VAR 	= 1;
		const REASON_CHANGED_SECONDARY_VAR 	= 2;
		const REASON_CHANGED_YEAR		  	= 4;
		const REASON_CHANGED_CITY		  	= 8;
		const REASON_ENABLED_SECONDARY_VAR	= 16;		
		const REASON_DISABLED_SECONDARY_VAR = 32;
		
        ready(function(){

	        parser.parse();
	
			dgPrimary = registry.byId("dgAttr1"); dgSecondary = registry.byId("dgAttr2");
			domStyle.set(dgPrimary.id, "color", cityConnectorColor1);
			domStyle.set(dgSecondary.id, "color", cityConnectorColor2);
			
			map = new Map("map", {
				extent: new Extent({
					xmin:-13782695.087618, ymin:1811961.3496825, xmax:-7624505.68790585, ymax:7632806.32470579,
					spatialReference:{wkid:102100}
				})
			});
			//create the custom info window specifying any input options
			var infoWindow = new CustomInfoWindow({ domNode: domConstruct.create("div", null, dom.byId("map"))});
			// infoWindow.startup();
			map.setInfoWindow(infoWindow);


			var tlBasemap = new ArcGISTiledMapServiceLayer(
				config.services.basemap);
			map.addLayer(tlBasemap);

			// Set up and add the connecting-lines graphics layer
			glCityConnectors = new GraphicsLayer();
			map.addLayer(glCityConnectors);
			
			// Define the popup for the cities; the body of the message changes by chosen year
			// and will be updated in the onChange event for the Select widget
			itPopup = new InfoTemplate("${NAME}, ${ST}");
			
			flCities = new FeatureLayer(
				config.services.cities,
				{
					mode:FeatureLayer.MODE_SNAPSHOT,
					outFields:["*"],
					htmlPopupType: FeatureLayer.POPUP_HTML_TEXT,
					infoTemplate: itPopup
			});
			
			// infoWindow.resize(100, 100);

			flCities.on("click", onCitySelected);
	        
	        map.addLayer(flCities);
	        
	        var tlReference = new ArcGISTiledMapServiceLayer(
	        	"https://services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer"
	        	);
	        map.addLayer(tlReference);
	        
	        //add the scalebar 
	        var scalebar = new Scalebar({
				map: map,
				scalebarUnit: "english"
	 		});

			createDropdowns();			
			createChart();
			
			cbShowSecondComparisonVariable = new CheckBox({
				name: "cbShowSecondComparisonVariable",
				checked: false,
				onChange: onShowSecondComparisonVariableChanged
			}, selShowSecondComparisonVariable);
		});

		/** EVENTS **/
		function onYearSelected(yearValue) {
			showNearestCities(REASON_CHANGED_YEAR);
		}
		
		function onFirstComparisonVariableSelected(firstComparisonVarValue) {
			// First disable the corresponding item in the second variable list
			var secondaryVar = ddlSecondComparisonVariable.get("value");
			
			for (var i = 0; i < this.options.length; i++) {
				delete ddlSecondComparisonVariable.options[i].disabled;
				if (this.options[i].value == firstComparisonVarValue) {
					// Here's the chosen primary var and thus the secondary var to disable. 
					// If it's the same as the secondary variable,
					// enable the option and disable the entire widget
					if (this.options[i].value == secondaryVar) {
						cbShowSecondComparisonVariable.set("checked", false);
						// Set 2nd variable selection to something else
						ddlSecondComparisonVariable.set(
							"value", 
							i > 0 ? ddlSecondComparisonVariable.options[0].value : ddlSecondComparisonVariable.options[1].value);
					}
					ddlSecondComparisonVariable.options[i].disabled = true;					
					
				}
			}
			ddlSecondComparisonVariable.startup();
							
			// ddlSecondComparisonVariable.options
			showNearestCities(REASON_CHANGED_PRIMARY_VAR);
		}
		
		function onSecondComparisonVarSelected(secondComparisonVarValue) {
			showNearestCities(REASON_CHANGED_SECONDARY_VAR);
		}
		
		function onCitySelected(clickEvent) {
			gpcSelectedCity = clickEvent.graphic;
			showNearestCities(REASON_CHANGED_CITY);
		}
		
        function onShowSecondComparisonVariableChanged(value) {
			domStyle.set(ddlSecondComparisonVariable.domNode, "display", value ? "" : "none");
			showNearestCities(value ? REASON_ENABLED_SECONDARY_VAR : REASON_DISABLED_SECONDARY_VAR);
        }

		/** END EVENTS **/
		
		/** RECALCULATION FUNCTIONS **/
		
		function showNearestCities(reason) {
			var selectedYearVal = ddlYear.get("value");
			var selectedVar1Field = ddlFirstComparisonVariable.get("value");
			var selectedVar2Field = ddlSecondComparisonVariable.get("value");
			var bVar2Enabled = cbShowSecondComparisonVariable.checked;
			
			switch (reason) {
				case REASON_ENABLED_SECONDARY_VAR:
				case REASON_CHANGED_SECONDARY_VAR:
					if (gpcSelectedCity == null || selectedYearVal == null) return;
					if (bVar2Enabled && selectedVar2Field != null) {
						calcAndDisplaySecondAttrInfo(selectedVar2Field, selectedYearVal);
					}
					break;
				case REASON_CHANGED_YEAR:
				case REASON_CHANGED_CITY:
					if (gpcSelectedCity == null || selectedYearVal == null || selectedVar1Field == null) return;
					if (bVar2Enabled && selectedVar2Field != null) {
						calcAndDisplaySecondAttrInfo(selectedVar2Field, selectedYearVal);
					}
					// don't break; fall through to also process primary var
				case REASON_CHANGED_PRIMARY_VAR:
					if (gpcSelectedCity == null || selectedYearVal == null || selectedVar1Field == null) return;
					// Calc & display first var info
					var sAttrFieldNameToday = JSONQuery(
						"$[?label='" + baselineYear + "'][0].fields[?field='" + selectedVar1Field + "'][0].fieldname",
						config.fieldmap);
					var sAttrFieldNameSelectedYear = JSONQuery(
						"$[?label='" + selectedYearVal + "'][0].fields[?field='" + selectedVar1Field + "'][0].fieldname", 
						config.fieldmap);
					var nTargetCityComparisonVal = gpcSelectedCity.attributes[sAttrFieldNameSelectedYear];
					
					// Update the right-pane descriptive text
					updateDescription(
						nTargetCityComparisonVal, baselineYear, 
						gpcSelectedCity.attributes.NAME, gpcSelectedCity.attributes.ST);
		
					// Update the body of the popup with an updated field reference for the chosen year
					var sContent = "Value: <b>" + gpcSelectedCity.attributes[sAttrFieldNameSelectedYear] + "</b> (for " + selectedYearVal + ")";
					itPopup.setContent(sContent);
					map.infoWindow.setContent(sContent);
					
					showNearestCitiesForOneVar(
						selectedVar1Field, nTargetCityComparisonVal, sAttrFieldNameToday, sAttrFieldNameSelectedYear,
						slsCityConnector1,
						dgPrimary, chartSeries1);
					break;
				case REASON_DISABLED_SECONDARY_VAR:
					setDatagridVisibilityById(dgSecondary.id, false);
					removeConnectionsForOneAttribute(slsCityConnector2);
					cityChart.updateSeries(chartSeries2, []);
					cityChart.fullRender();
					break;
			}
		}
		
		function calcAndDisplaySecondAttrInfo(selectedVar2Field, selectedYearVal) {
			var sQSFieldNameToday = "$[?label='" + baselineYear + "'][0].fields[?field='" + selectedVar2Field + "'][0].fieldname";
			var sAttrFieldNameToday = JSONQuery(sQSFieldNameToday, config.fieldmap);
			
			var sQSFieldNameSelectedYear=  "$[?label='" + selectedYearVal + "'][0].fields[?field='" + selectedVar2Field + "'][0].fieldname";
			var sAttrFieldNameSelectedYear = JSONQuery(sQSFieldNameSelectedYear, config.fieldmap);
			
			var nTargetCityComparisonVal = gpcSelectedCity.attributes[sAttrFieldNameSelectedYear];
			
			showNearestCitiesForOneVar(
				selectedVar2Field, nTargetCityComparisonVal, sAttrFieldNameToday, sAttrFieldNameSelectedYear,
				slsCityConnector2,
				dgSecondary, chartSeries2);						
		}
		
		function setDatagridVisibilityById(dgId, visible) {
			domStyle.set(dgId, {"visibility": visible ? "visible" : "hidden"});
		}
		
		function showNearestCitiesForOneVar(
			selectedVarField, nTargetCityComparisonVal, sAttrFieldNameToday, sAttrFieldNameSelectedYear,
			slsCityConnector,
			dataGrid, chartSeries) {
			/* Prepare two sets of data for three purposes:
			 * 1. Lines on map for closest cities
			 * 2. Datagrid entries for closest cities;
			 * 3. Attribute values for chart
			 */
			var aryGraphics = gpcSelectedCity._graphicsLayer.graphics;

			// Sort graphics in order of closest match to selected city 
			aryGraphics.sort(function(a, b) {
				var diffA = Math.abs(nTargetCityComparisonVal - a.attributes[sAttrFieldNameToday]);
				var diffB = Math.abs(nTargetCityComparisonVal - b.attributes[sAttrFieldNameToday]);
				return diffA - diffB;
			});
			var aryClosestCities = [];
			for (var i = 0, citiesAnalyzed = 0; citiesAnalyzed < 5; i++) {
				var g = aryGraphics[i];
				if (g.attributes["OBJECTID"] != gpcSelectedCity.attributes["OBJECTID"]) {
					aryClosestCities.push(g);
					citiesAnalyzed++;
				}
			}
			
			// Get data for datagrid
			var aryClosestCityTable = aryClosestCities.map(function(gpcClosestCity) {
				// return gpcClosestCity.attributes;
				return {
					"NAME": 	gpcClosestCity.attributes.NAME,
					"ST": 		gpcClosestCity.attributes.ST,
					// name of Value attribute must match that defined in the table attribute below in HTML
					"Value": gpcClosestCity.attributes[sAttrFieldNameToday]
				};
			});
			var store = new ItemFileReadStore({data: {items: aryClosestCityTable}});
			dataGrid.setStore(store);
			setDatagridVisibilityById(dataGrid.id, true);
			
			// Update the chart
			aryChartData = config.fieldmap.map(function(fieldItem){
				var sFieldname = JSONQuery("$[?field='" + selectedVarField + "'][0].fieldname", fieldItem.fields);
				return gpcSelectedCity.attributes[sFieldname];
			});
			cityChart.title = gpcSelectedCity.attributes.NAME
								+ ", " 
								+ gpcSelectedCity.attributes.ST;
			domStyle.set("cityChart", {"visibility":"visible"});
			cityChart.updateSeries(chartSeries, aryChartData);
			cityChart.fullRender();
			
			/* Now draw connecting lines to the closest cities */
			// 1. Remove all graphics for this attribute
			removeConnectionsForOneAttribute(slsCityConnector);
			
			// 2. Add new graphics and animate them
			for (var i = 0; i < aryClosestCities.length; i++) {
				var gpcNearbyCity = aryClosestCities[i];
				var pl = new Polyline([
					[gpcSelectedCity.geometry.x, gpcSelectedCity.geometry.y],
					[gpcNearbyCity.geometry.x, gpcNearbyCity.geometry.y]
				]);
				pl.spatialReference = map.spatialReference;
				var gpcConnector = new Graphic(pl, slsCityConnector);
				var apl = new PolylineAnimation({
					graphic			: gpcConnector, 
					graphicsLayer	: glCityConnectors,
					duration		: 2500
				});
				apl.animatePolyline();
			}
		};

		function removeConnectionsForOneAttribute(slsConnectionSymbol) {
			for (var i = glCityConnectors.graphics.length - 1; i >=0; i--) {
				var graphic = glCityConnectors.graphics[i];
				if (graphic.symbol == slsConnectionSymbol) glCityConnectors.remove(graphic);
			}
		}

        function updateDescription(value, baselineYear, city, state) {
        	var sDesc1 = "For " + city + ", " + state + ", the";
        	var sDesc2 =  "is " + value + ". "
        		+ "Here are five cities that should feel similar right now:";
        	dojo.byId("lblSelectDescription1").innerHTML = sDesc1;
        	dojo.byId("lblSelectDescription2").innerHTML = sDesc2;
        }
        
        /** END RECALCULATION FUNCTIONS **/
       
       /** INITIALIZATION **/
        
        function createDropdowns() {
	        // Set up dropdown list of years
	        // var yearDataStore = new ItemFileReadStore({data: {items: config.fieldmap}});
			var yearDataStore = new ItemFileReadStore({
				data:{
					identifier:"label", label:"label", items: config.fieldmap
				},				
				"hierarchical": false
			});
	        ddlYear = new Select({
                name: "ddlYear",
                store: yearDataStore
            }, "ddlYear");
			ddlYear.on("change", onYearSelected);
			// ddlYear.onChange();
			ddlYear.startup();
			
			// Set up dropdown list of comparison variables
			var varDataStore = new ItemFileReadStore({
				data:{
					identifier:"field", label:"descShort", items: config.fieldDescriptions
				}
			});
			ddlFirstComparisonVariable = new Select({
				name: "ddlComparisonVariable",
				store: varDataStore
			}, "ddlComparisonVariable");
			ddlFirstComparisonVariable.on("change", onFirstComparisonVariableSelected);
			ddlFirstComparisonVariable.startup();
 			
			var secondAttributeStore = new ItemFileReadStore({
				data:{
					identifier:"field", label:"descShort", items: config.fieldDescriptions
				}
			});
			ddlSecondComparisonVariable = new Select({
				name: "ddlSecondComparisonVariable",
				store:varDataStore,
			}, "ddlSecondComparisonVariable");
			ddlSecondComparisonVariable.on("change", onSecondComparisonVarSelected);
			domStyle.set(ddlSecondComparisonVariable.domNode, "display", "none");
			ddlSecondComparisonVariable.options[0].selected = false;
			ddlSecondComparisonVariable.options[0].disabled = true;
			ddlSecondComparisonVariable.options[1].selected = true;
			ddlSecondComparisonVariable.startup();
			
			// ddlComparisonVariable.onChange(ddlComparisonVariable.get("value"));
       }
        
        function createChart() {
		 
			cityChart = new Chart("cityChart", {titleFont: "normal normal normal 12pt Arial"});
		    // Set the theme
		    cityChart.setTheme(ChartTheme);
		 
		    // Add the only/default plot
		    cityChart.addPlot("default", {
		        type: "Lines",
		        hAxis: "x",
		        vAxis: "y",
		        markers: true,
		        stroke: {color:"tan"}
		    });
		 
		    // Add axes
		    cityChart.addAxis("x", {
		    	labels: [
		    		{value:1, text:"2010"},
		    		{value:2, text:"2020"},
		    		{value:3, text:"2030"},
		    		{value:4, text:"2040"},
		    		{value:5, text:"2050"},
		    		{value:6, text:"2060"},
		    		{value:7, text:"2070"},
		    		{value:8, text:"2080"},
		    		{value:9, text:"2090"}
		    	]
		    });
		    cityChart.addAxis("y", { 
		    	vertical: true, includeZero: true,  
		    	fixLower: "major", fixUpper: "major", 
		    	title: null
		    });
		 
		    // Add the series of data
		    cityChart.addSeries(chartSeries1, [], {stroke:{color:cityConnectorColor1}, fill: cityConnectorColor1, marker: ChartTheme.markers.CIRCLE});
		    cityChart.addSeries(chartSeries2, [], {stroke:{color:cityConnectorColor2}, fill: cityConnectorColor2, marker: ChartTheme.markers.TRIANGLE});
		    
		    // Add tooltips
		    var tip = new ChartTooltip(cityChart, "default");
		    
		    // cityChart.render();
        }
        
        /** END INITIALIZATION **/
        
	});
    </script>
  </head>

	<body class="claro">
		<div id="mainWindow" data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design:'headline'" style="width:100%; height:100%;">
			<div id="header" class="shadow roundedCorners" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'top'">
				<div id="title">Heat-Related Indices for Selected Cities</div>
				<div id="subtitle" style="visibility:gone"></div>
			</div>

			<div id="map" class="roundedCorners shadow" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="height:50%;"></div>

			<div id="rightPane" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'right'" style="padding:0;">
				<div id="rightPaneContent" data-dojo-type="dijit.layout.BorderContainer" style="border:transparent; width:100%; height:100%; padding:0; margin: 0; font-size:smaller;">
					<div id="rightTopContent" class="rightPaneContent" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'top'" style="background:transparent;; border:0px;">
						<label id="lblSelectDescription1">Click a city to see its</label>
						<div id="ddlComparisonVariable"></div>
						<label id="lblFor">for</label>
						<div id="ddlYear"></div>
						<label id="lblSelectDescription2">. You'll also see the five cities that feel most like it right now.</label>
					</div>
					<div id="rightCenterContent" class="rightPaneContent" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="background:transparent">
						<table data-dojo-type="dojox.grid.DataGrid" jsid="dgAttr1" id="dgAttr1" style="visibility:hidden">
							<thead>
								<tr>
									<th field="NAME" width="50%"> City </th>
									<th field="ST" width="15%">&nbsp;</th>
									<th field="Value" width="35%"> Value </th>
								</tr>
							</thead>
						</table>
						
						<!-- The Chart -->
						<div id="cityChart" style="width:100%; height:200px;"></div>
						
						<br/><br/>
						
						<!-- Second attribute -->
						<div id="selShowSecondComparisonVariable"></div>
						<label for="selShowSecondComparisonVariable">Show another attribute</label>
						<div id="ddlSecondComparisonVariable"></div>
						<table data-dojo-type="dojox.grid.DataGrid" jsid="dgAttr2" id="dgAttr2" style="visibility:hidden">
							<thead>
								<tr>
									<th field="NAME" width="50%"> City </th>
									<th field="ST" width="15%">&nbsp;</th>
									<th field="Value" width="35%"> Value </th>
								</tr>
							</thead>
						</table>
					</div>
					<div id="rightBottomContent" class="rightPaneContent" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'bottom'" style="background:transparent; ">
						<label style="height: 100%; font-size: smaller">
							Climate data courtesy of NOAA Geophysical Fluid Dynamics Laboratory (GFDL).
							The output is from Model and Experiment GFDL-CMIP5-ESM2M-RCP60, available 
								<a href="http://nomads.gfdl.noaa.gov:8080/DataPortal/cmip5.jsp" target="_blank">here</a>.
							<br/>
							Please see the <a href="http://nomads.gfdl.noaa.gov/" target="_blank">GFDL Data Portal</a> for further information.
							
						</label>
						
						<!-- Future color-picker -->
						<!-- <div data-dojo-type="dijit.form.DropDownButton">
						    <span>
						        ColorPicker
						    </span>
						    <div data-dojo-type="dojox.widget.ColorPicker" id="picker3"></div>
						</div>
						
						<div data-dojo-type="dijit/ColorPalette" data-dojo-props="onChange:function(){alert(this.value);}, palette:'3x4'"></div>					</div> -->				</div>
			</div>

		</div>
	</body>
</html>
